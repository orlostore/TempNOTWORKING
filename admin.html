<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-B5JQFPTZT7"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-B5JQFPTZT7');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ORLO Admin</title>
    <meta name="robots" content="noindex, nofollow">
    <link rel="icon" type="image/png" href="logo.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Almarai:wght@400;700&display=swap" rel="stylesheet">
    <style>html{opacity:0;transition:opacity .15s}</style>
    <script>Promise.race([document.fonts.ready,new Promise(function(r){setTimeout(r,1500)})]).then(function(){document.documentElement.style.opacity='1'})</script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --primary: #2c4a5c;
            --accent: #e07856;
            --accent-hover: #c96644;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --bg: #f8f9fa;
            --white: #ffffff;
            --text: #333;
            --text-light: #666;
            --border: #e0e0e0;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            min-height: 100vh;
            color: var(--text);
        }
        
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        
        /* Header */
        header {
            background: linear-gradient(135deg, var(--primary) 0%, #1e3d4d 100%);
            color: white;
            padding: 20px 30px;
            border-radius: 12px;
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 15px rgba(44, 74, 92, 0.3);
        }
        .header-brand {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .header-brand img {
            width: 50px;
            height: 50px;
        }
        .header-brand h1 {
            font-size: 1.4rem;
            font-weight: 700;
        }
        .header-brand span {
            font-size: 0.85rem;
            opacity: 0.9;
            font-weight: 400;
        }
        .header-actions { display: flex; gap: 10px; }
        
        /* Tabs */
        .tabs {
            display: flex;
            gap: 0;
            margin-bottom: 25px;
            background: white;
            border-radius: 12px;
            padding: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
        .tab {
            padding: 12px 30px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95rem;
            color: var(--text-light);
            border-radius: 8px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .tab:hover { background: #f0f0f0; }
        .tab.active {
            background: var(--primary);
            color: white;
        }
        .tab-badge {
            background: var(--accent);
            color: white;
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 10px;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Orders styles */
        .order-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            margin-bottom: 15px;
            overflow: hidden;
        }
        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: #fafafa;
            border-bottom: 1px solid var(--border);
            flex-wrap: wrap;
            gap: 10px;
        }
        .order-id {
            font-weight: 700;
            color: var(--primary);
            font-size: 0.9rem;
        }
        .order-date {
            color: var(--text-light);
            font-size: 0.85rem;
        }
        .order-amount {
            font-weight: 700;
            color: var(--accent);
            font-size: 1.1rem;
        }
        .order-status {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        .order-status.pending {
            background: #fff3cd;
            color: #856404;
        }
        .order-status.shipped {
            background: #d4edda;
            color: #155724;
        }
        .order-body { padding: 20px; }
        .order-customer {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .order-customer-info h4 {
            font-size: 0.8rem;
            color: var(--text-light);
            text-transform: uppercase;
            margin-bottom: 8px;
        }
        .order-customer-info p {
            font-size: 0.9rem;
            color: var(--text);
            line-height: 1.5;
        }
        .order-items {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .order-items h4 {
            font-size: 0.8rem;
            color: var(--text-light);
            text-transform: uppercase;
            margin-bottom: 10px;
        }
        .order-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            font-size: 0.9rem;
        }
        .order-item:last-child { border-bottom: none; }
        .order-item-name { color: var(--text); }
        .order-item-qty { color: var(--text-light); }
        .order-item-price { font-weight: 600; color: var(--primary); }
        .order-actions {
            display: flex;
            gap: 10px;
            padding-top: 15px;
            border-top: 1px solid var(--border);
        }
        .orders-empty {
            text-align: center;
            padding: 60px 20px;
            background: white;
            border-radius: 12px;
        }
        .orders-empty-icon { font-size: 4rem; margin-bottom: 15px; }
        .orders-loading {
            text-align: center;
            padding: 60px;
            background: white;
            border-radius: 12px;
        }

        /* Filters Bar */
        .filters-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            flex-wrap: wrap;
            align-items: flex-end;
        }
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .filter-group label {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-light);
        }
        .filter-group select {
            padding: 8px 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 0.85rem;
            min-width: 150px;
            cursor: pointer;
        }
        .filter-group select:focus {
            outline: none;
            border-color: var(--accent);
        }

        /* View Toggle */
        .view-toggle {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            background: white;
            padding: 5px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
        .view-btn {
            padding: 10px 20px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--text-light);
            border-radius: 8px;
            transition: all 0.2s;
        }
        .view-btn:hover { background: #f0f0f0; }
        .view-btn.active {
            background: var(--primary);
            color: white;
        }

        /* Dashboard Views */
        .dashboard-view { display: none; }
        .dashboard-view.active { display: block; }

        /* Shipping Summary */
        .shipping-summary {
            background: white;
            border-radius: 0 0 12px 12px;
            padding: 20px;
        }
        .shipping-cards {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }
        .shipping-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        .shipping-card h4 {
            font-size: 0.85rem;
            color: var(--text-light);
            margin-bottom: 10px;
        }
        .shipping-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
        }
        .shipping-value.highlight {
            color: var(--accent);
        }
        .shipping-amount {
            font-size: 1rem;
            color: var(--success);
            font-weight: 600;
            margin-top: 5px;
        }
        .shipping-label {
            font-size: 0.8rem;
            color: var(--text-light);
            margin-top: 5px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .filters-bar { flex-direction: column; align-items: stretch; }
            .filter-group select { width: 100%; }
            .shipping-cards { grid-template-columns: 1fr; }
            .view-toggle { flex-wrap: wrap; }
        }
        @media (max-width: 768px) {
            .shipping-value { font-size: 1.5rem; }
        }
        
        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .btn-primary { background: var(--accent); color: white; }
        .btn-primary:hover { background: var(--accent-hover); transform: translateY(-1px); }
        .btn-secondary { background: rgba(255,255,255,0.15); color: white; border: 1px solid rgba(255,255,255,0.3); }
        .btn-secondary:hover { background: rgba(255,255,255,0.25); }
        .btn-success { background: var(--success); color: white; }
        .btn-success:hover { background: #218838; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-danger:hover { background: #c82333; }
        .btn-small { padding: 6px 12px; font-size: 0.8rem; }
        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }
        .btn-outline:hover {
            background: var(--primary);
            color: white;
        }
        
        /* Stats Cards */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            border-left: 4px solid var(--primary);
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
            user-select: none;
        }
        .stat-card:hover { transform: translateY(-2px); }
        .stat-card.selected {
            box-shadow: 0 0 0 3px var(--accent), 0 2px 10px rgba(0,0,0,0.12);
            transform: translateY(-2px);
        }

        /* Active filter banner */
        .filter-banner {
            display: none;
            background: var(--accent);
            color: white;
            padding: 10px 16px;
            border-radius: 10px;
            margin-bottom: 15px;
            font-size: 0.9rem;
            font-weight: 500;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }
        .filter-banner.active { display: flex; }
        .filter-banner-close {
            background: rgba(255,255,255,0.25);
            border: none;
            color: white;
            padding: 4px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
        }
        .filter-banner-close:hover { background: rgba(255,255,255,0.4); }
        .stat-card h3 {
            color: var(--text-light);
            font-size: 0.85rem;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .stat-card .value {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--primary);
        }
        .stat-card.warning { border-left-color: var(--warning); }
        .stat-card.warning .value { color: #b38600; }
        .stat-card.danger { border-left-color: var(--danger); }
        .stat-card.danger .value { color: var(--danger); }
        .stat-card.success { border-left-color: var(--success); }
        .stat-card.success .value { color: var(--success); }
        
        /* Products Table */
        .products-table {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            overflow: hidden;
        }
        .table-header {
            padding: 20px 25px;
            background: white;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        .table-header h2 {
            font-size: 1.1rem;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .search-box {
            padding: 10px 15px;
            border: 2px solid var(--border);
            border-radius: 8px;
            width: 280px;
            font-size: 0.9rem;
            transition: border-color 0.2s;
        }
        .search-box:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 15px 20px;
            text-align: left;
            border-bottom: 1px solid #f0f0f0;
        }
        th {
            background: #fafafa;
            font-weight: 600;
            color: var(--text-light);
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        td { font-size: 0.9rem; }
        tr:hover { background: #fafafa; }
        
        .product-img {
            width: 55px;
            height: 55px;
            object-fit: contain;
            border-radius: 8px;
            background: #f5f5f5;
            padding: 5px;
        }
        .product-name {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 2px;
        }
        .product-name-ar {
            font-size: 0.8rem;
            color: var(--text-light);
            font-family: 'Almarai', sans-serif;
        }
        .product-slug {
            font-size: 0.75rem;
            color: #999;
            font-family: monospace;
        }
        
        .qty-badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .qty-badge:hover { transform: scale(1.05); }
        .qty-ok { background: #d4edda; color: #155724; }
        .qty-low { background: #fff3cd; color: #856404; }
        .qty-out { background: #f8d7da; color: #721c24; }
        
        .actions { display: flex; gap: 8px; }

        .reorder-arrows {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .reorder-btn {
            background: none;
            border: 1px solid var(--border);
            border-radius: 4px;
            cursor: pointer;
            padding: 2px 6px;
            font-size: 0.7rem;
            color: var(--text-light);
            transition: all 0.2s;
            line-height: 1;
        }
        .reorder-btn:hover { background: var(--primary); color: white; border-color: var(--primary); }
        .reorder-btn:disabled { opacity: 0.2; cursor: default; background: none; color: var(--text-light); border-color: var(--border); }
        
        .price-tag {
            font-weight: 600;
            color: var(--accent);
        }
        
        .category-tag {
            background: #e8f4f8;
            color: var(--primary);
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .modal-overlay.active { display: flex; }
        
        .modal {
            background: white;
            border-radius: 16px;
            width: 100%;
            max-width: 750px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .modal-header {
            padding: 25px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            flex-shrink: 0;
        }
        .modal-header h2 {
            font-size: 1.3rem;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .modal-close {
            background: none;
            border: none;
            font-size: 1.8rem;
            cursor: pointer;
            color: #999;
            transition: color 0.2s;
            line-height: 1;
        }
        .modal-close:hover { color: var(--danger); }
        .modal-body { padding: 25px; overflow-y: auto; flex: 1; }
        .modal-footer {
            padding: 20px 25px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            background: #fafafa;
            flex-shrink: 0;
        }
        
        .form-section {
            margin-bottom: 25px;
            padding-bottom: 25px;
            border-bottom: 1px solid #f0f0f0;
        }
        .form-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .form-section-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .form-group { margin-bottom: 15px; }
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--text-light);
            font-size: 0.85rem;
        }
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 0.9rem;
            transition: border-color 0.2s;
        }
        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--accent);
        }
        .form-group textarea { min-height: 100px; resize: vertical; }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .pricing-row { grid-template-columns: 1fr 1fr 1fr; }
        .form-hint {
            font-size: 0.75rem;
            color: #999;
            margin-top: 4px;
        }
        
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            font-weight: 500;
        }
        .checkbox-label input {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .loading {
            text-align: center;
            padding: 60px;
            color: var(--text-light);
        }
        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Auth screen */
        .auth-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--primary) 0%, #1e3d4d 100%);
            padding: 20px;
        }
        .auth-box {
            background: white;
            padding: 50px 40px;
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 400px;
            width: 100%;
        }
        .auth-box img {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
        }
        .auth-box h1 {
            margin-bottom: 10px;
            color: var(--primary);
            font-size: 1.5rem;
        }
        .auth-box p {
            color: var(--text-light);
            margin-bottom: 25px;
            font-size: 0.9rem;
        }
        .auth-box input {
            padding: 14px 20px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 1rem;
            width: 100%;
            margin-bottom: 15px;
            text-align: center;
        }
        .auth-box input:focus {
            outline: none;
            border-color: var(--accent);
        }
        .auth-box .btn {
            width: 100%;
            padding: 14px;
            font-size: 1rem;
        }
        .auth-error {
            color: var(--danger);
            margin-top: 15px;
            display: none;
            font-size: 0.9rem;
        }
        
        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }
        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 15px;
        }
        .empty-state h3 {
            color: var(--primary);
            margin-bottom: 10px;
        }
        .empty-state p {
            color: var(--text-light);
            margin-bottom: 20px;
        }
        
        /* ============ MOBILE RESPONSIVE ============ */
        @media (max-width: 768px) {
            /* Container */
            .container { padding: 10px; }

            /* Header - stack vertically */
            header {
                flex-direction: column;
                gap: 12px;
                padding: 15px;
                border-radius: 10px;
                margin-bottom: 15px;
                text-align: center;
            }
            .header-brand { justify-content: center; gap: 10px; }
            .header-brand img { width: 36px; height: 36px; }
            .header-brand h1 { font-size: 1.1rem; }
            .header-brand span { display: none; }
            .header-actions {
                width: 100%;
                justify-content: center;
            }
            .header-actions .btn { flex: 1; justify-content: center; padding: 10px 12px; font-size: 0.8rem; }

            /* Tabs - horizontal scroll */
            .tabs {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                gap: 0;
                padding: 4px;
                margin-bottom: 15px;
            }
            .tab {
                padding: 10px 16px;
                font-size: 0.85rem;
                white-space: nowrap;
                flex-shrink: 0;
            }

            /* Stats - 2 columns */
            .stats {
                grid-template-columns: 1fr 1fr;
                gap: 10px;
                margin-bottom: 15px;
            }
            .stat-card {
                padding: 15px;
                border-radius: 10px;
            }
            .stat-card h3 { font-size: 0.7rem; margin-bottom: 4px; }
            .stat-card .value { font-size: 1.5rem; }

            /* Filter banner */
            .filter-banner { font-size: 0.8rem; padding: 8px 12px; }

            /* Products table - card layout on mobile */
            .products-table { border-radius: 10px; }
            .table-header {
                flex-direction: column;
                align-items: stretch;
                padding: 15px;
                gap: 10px;
            }
            .table-header h2 { font-size: 1rem; }
            .search-box { width: 100%; }

            table, thead, tbody, th, td, tr { display: block; }
            thead { display: none; }
            tr {
                margin-bottom: 12px;
                border-bottom: 2px solid var(--border);
                padding-bottom: 12px;
                position: relative;
            }
            tr:last-child { border-bottom: none; margin-bottom: 0; }
            td {
                padding: 4px 15px;
                text-align: left;
                border-bottom: none;
                display: flex;
                align-items: center;
                gap: 10px;
            }
            td:first-child { padding-top: 10px; }
            .reorder-arrows { flex-direction: row; gap: 6px; }
            .reorder-btn { padding: 4px 10px; font-size: 0.75rem; }
            .product-img { width: 45px; height: 45px; }

            .actions {
                flex-direction: row;
                justify-content: flex-start;
                gap: 8px;
                padding-top: 8px;
            }

            /* Form */
            .form-row, .pricing-row { grid-template-columns: 1fr; }

            /* Orders tab */
            .order-header {
                flex-direction: column;
                align-items: flex-start;
                padding: 12px 15px;
                gap: 8px;
            }
            .order-body { padding: 15px; }
            .order-customer {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            .order-items { padding: 12px; }
            .order-item {
                flex-wrap: wrap;
                gap: 4px;
            }
            .order-item-name { flex-basis: 100%; }
            .order-actions {
                flex-direction: column;
                gap: 8px;
            }
            .order-actions .btn { width: 100%; justify-content: center; }

            /* View toggle */
            .view-toggle { flex-wrap: wrap; }
            .view-btn { flex: 1; text-align: center; min-width: 0; padding: 8px 10px; font-size: 0.8rem; }

            /* Modal - full screen on mobile */
            .modal-overlay { padding: 0; align-items: stretch; }
            .modal {
                border-radius: 0;
                max-height: 100dvh;
                height: 100dvh;
                max-width: 100%;
            }
            .modal-header { padding: 15px; }
            .modal-header h2 { font-size: 1.1rem; }
            .modal-body { padding: 15px; }
            .modal-footer { padding: 15px; }

            /* Quick stock modal stays compact */
            #stockModal .modal {
                height: auto;
                max-height: 90vh;
                border-radius: 16px;
                margin: 20px;
            }

            /* Variant / tier rows */
            .variant-row {
                grid-template-columns: 1fr 1fr !important;
                gap: 6px !important;
            }
            .variant-row input:nth-child(3) { grid-column: 1 / -1; }
            .tier-row {
                grid-template-columns: 1fr 1fr 40px !important;
            }
        }

        /* Small phones */
        @media (max-width: 400px) {
            .stats { grid-template-columns: 1fr; }
            .stat-card .value { font-size: 1.8rem; }
            .header-actions { flex-direction: column; }
            .header-actions .btn { width: 100%; }
        }
    </style>
</head>
<body>
    <!-- Auth Screen -->
    <div class="auth-screen" id="authScreen">
        <div class="auth-box">
            <img src="logo.png" alt="ORLO" onerror="this.style.display='none'">
            <h1>ORLO Admin</h1>
            <p>Enter your admin key to continue</p>
            <input type="password" id="authKey" placeholder="Admin Key">
            <button class="btn btn-primary" onclick="authenticate()">Login</button>
            <p class="auth-error" id="authError">Invalid admin key</p>
        </div>
    </div>

    <!-- Main Admin Panel -->
    <div class="container" id="adminPanel" style="display:none;">
        <header>
            <div class="header-brand">
                <img src="logo.png" alt="ORLO" onerror="this.outerHTML='<span style=font-size:2rem>üì¶</span>'">
                <div>
                    <h1>ORLO Admin</h1>
                    <span>Inventory Management System</span>
                </div>
            </div>
            <div class="header-actions">
                <button class="btn btn-primary" onclick="openAddModal()">+ Add Product</button>
                <button class="btn btn-secondary" onclick="refreshProducts()">Refresh</button>
            </div>
        </header>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('products')">üì¶ Products</button>
            <button class="tab" onclick="switchTab('orders')">üìã Orders <span class="tab-badge" id="pendingOrdersBadge">0</span></button>
        </div>

        <!-- Products Tab -->
        <div class="tab-content active" id="productsTab">
            <div class="stats" id="stats">
                <div class="stat-card" onclick="filterByStock('all')">
                    <h3>Total Products</h3>
                    <div class="value" id="statTotal">-</div>
                </div>
                <div class="stat-card success" onclick="filterByStock('instock')">
                    <h3>In Stock</h3>
                    <div class="value" id="statInStock">-</div>
                </div>
                <div class="stat-card warning" onclick="filterByStock('low')">
                    <h3>Low Stock (&lt;10)</h3>
                    <div class="value" id="statLowStock">-</div>
                </div>
                <div class="stat-card danger" onclick="filterByStock('out')">
                    <h3>Out of Stock</h3>
                    <div class="value" id="statOutOfStock">-</div>
                </div>
            </div>

            <div class="filter-banner" id="stockFilterBanner">
                <span id="stockFilterLabel"></span>
                <button class="filter-banner-close" onclick="clearStockFilter()">Clear</button>
            </div>

            <div class="products-table">
                <div class="table-header">
                    <h2>Products</h2>
                    <input type="text" class="search-box" placeholder="Search products..." id="searchBox" oninput="filterProducts()">
                </div>
                <table>
                    <thead>
                        <tr>
                            <th style="width:50px;">#</th>
                            <th>Image</th>
                            <th>Product</th>
                            <th>Category</th>
                            <th>Price</th>
                            <th>Stock</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="productsBody">
                        <tr><td colspan="7" class="loading">
                            <div class="loading-spinner"></div>
                            <div>Loading products...</div>
                        </td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Orders Tab -->
        <div class="tab-content" id="ordersTab">
            <!-- Filters -->
            <div class="filters-bar">
                <div class="filter-group">
                    <label>üìÖ Period</label>
                    <select id="dateFilter" onchange="applyFilters()">
                        <option value="today">Today</option>
                        <option value="week">This Week</option>
                        <option value="month" selected>This Month</option>
                        <option value="year">This Year</option>
                        <option value="all">All Time</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>üì¶ Product</label>
                    <select id="productFilter" onchange="applyFilters()">
                        <option value="all">All Products</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>üöö Shipping</label>
                    <select id="shippingFilter" onchange="applyFilters()">
                        <option value="all">All Orders</option>
                        <option value="paid">Customer Paid</option>
                        <option value="free">Free Delivery</option>
                    </select>
                </div>
                <button class="btn btn-primary btn-small" onclick="loadOrders()">üîÑ Refresh</button>
            </div>

            <!-- Summary Stats -->
            <div class="stats" id="orderStats">
                <div class="stat-card">
                    <h3>üìà Revenue</h3>
                    <div class="value" id="statRevenue">AED 0</div>
                </div>
                <div class="stat-card">
                    <h3>üí∞ Cost</h3>
                    <div class="value" id="statCost">AED 0</div>
                </div>
                <div class="stat-card success">
                    <h3>‚ú® Profit</h3>
                    <div class="value" id="statProfit">AED 0</div>
                </div>
                <div class="stat-card">
                    <h3>üöö Shipping</h3>
                    <div class="value" id="statShipping">AED 0</div>
                </div>
                <div class="stat-card">
                    <h3>üì¶ Orders</h3>
                    <div class="value" id="statTotalOrders">0</div>
                </div>
                <div class="stat-card warning">
                    <h3>‚è≥ Pending</h3>
                    <div class="value" id="statPendingOrders">0</div>
                </div>
            </div>

            <!-- View Toggle -->
            <div class="view-toggle">
                <button class="view-btn active" onclick="switchView('orders')">üìã Orders</button>
                <button class="view-btn" onclick="switchView('products')">üì¶ By Product</button>
                <button class="view-btn" onclick="switchView('shipping')">üöö Shipping</button>
            </div>

            <!-- Orders View -->
            <div id="ordersView" class="dashboard-view active">
                <div class="table-header" style="background:white; border-radius:12px 12px 0 0; margin-bottom:0;">
                    <h2>üìã Orders</h2>
                    <span id="ordersCount">0 orders</span>
                </div>
                <div id="ordersContainer">
                    <div class="orders-loading">
                        <div class="loading-spinner"></div>
                        <div>Loading orders...</div>
                    </div>
                </div>
            </div>

            <!-- Products View -->
            <div id="productsView" class="dashboard-view">
                <div class="table-header" style="background:white; border-radius:12px 12px 0 0; margin-bottom:0;">
                    <h2>üì¶ Sales by Product</h2>
                </div>
                <div class="products-table" style="border-radius:0 0 12px 12px;">
                    <table>
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Units Sold</th>
                                <th>Revenue</th>
                                <th>Cost</th>
                                <th>Profit</th>
                                <th>Margin</th>
                            </tr>
                        </thead>
                        <tbody id="productsSalesBody">
                            <tr><td colspan="6" class="loading">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Shipping View -->
            <div id="shippingView" class="dashboard-view">
                <div class="table-header" style="background:white; border-radius:12px 12px 0 0; margin-bottom:0;">
                    <h2>üöö Shipping Summary</h2>
                </div>
                <div class="shipping-summary">
                    <div class="shipping-cards">
                        <div class="shipping-card">
                            <h4>Orders with Paid Shipping</h4>
                            <div class="shipping-value" id="paidShippingCount">0</div>
                            <div class="shipping-amount" id="paidShippingAmount">AED 0</div>
                        </div>
                        <div class="shipping-card">
                            <h4>Orders with Free Delivery</h4>
                            <div class="shipping-value" id="freeShippingCount">0</div>
                            <div class="shipping-label">Over AED 75</div>
                        </div>
                        <div class="shipping-card">
                            <h4>Total Shipping Collected</h4>
                            <div class="shipping-value highlight" id="totalShippingCollected">AED 0</div>
                        </div>
                    </div>
                    <div class="products-table" style="margin-top:20px; border-radius:12px;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Order Date</th>
                                    <th>Customer</th>
                                    <th>Order Total</th>
                                    <th>Shipping</th>
                                    <th>Type</th>
                                </tr>
                            </thead>
                            <tbody id="shippingTableBody">
                                <tr><td colspan="5" class="loading">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Modal -->
    <div class="modal-overlay" id="productModal">
        <div class="modal">
            <div class="modal-header">
                <h2 id="modalTitle">Add Product</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editId">
                
                <div class="form-section">
                    <div class="form-section-title">Basic Information</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Product Name (English) *</label>
                            <input type="text" id="formName" required placeholder="e.g. Masking Tape Roll">
                        </div>
                        <div class="form-group">
                            <label>Product Name (Arabic)</label>
                            <input type="text" id="formNameAr" dir="rtl" placeholder="ŸÖÿ´ÿßŸÑ: ÿ¥ÿ±Ÿäÿ∑ ŸÑÿßÿµŸÇ">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Slug (URL) *</label>
                            <input type="text" id="formSlug" placeholder="e.g. masking-tape-roll">
                            <div class="form-hint">Lowercase, use dashes instead of spaces</div>
                        </div>
                        <div class="form-group">
                            <label>Category</label>
                            <input type="text" id="formCategory" placeholder="e.g. Workspace">
                        </div>
                        <div class="form-group">
                            <label>Category (Arabic)</label>
                            <input type="text" id="formCategoryAr" placeholder="e.g. ŸÖÿ≥ÿßÿ≠ÿ© ÿßŸÑÿπŸÖŸÑ" dir="rtl" style="font-family: 'Almarai', sans-serif;">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-section-title">Pricing & Inventory</div>
                    <div class="form-row pricing-row">
                        <div class="form-group">
                            <label>Cost (AED)</label>
                            <input type="number" id="formCost" step="0.01" min="0" placeholder="0.00" oninput="calcMinPrice()">
                            <div class="form-hint">Your cost including shipping buffer</div>
                        </div>
                        <div class="form-group">
                            <label>Min. Selling Price (AED)</label>
                            <input type="text" id="formMinPrice" readonly style="background:#f0f4f0; color:#2d6a2e; font-weight:700; cursor:default;" placeholder="‚Äî" tabindex="-1">
                            <div class="form-hint">= (cost√ó2 + delivery/2) √∑ 0.97</div>
                        </div>
                        <div class="form-group">
                            <label>Price (AED) *</label>
                            <input type="number" id="formPrice" step="0.01" min="0" placeholder="Min. price used if empty">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Quantity in Stock *</label>
                            <input type="number" id="formQuantity" min="0" placeholder="0">
                        </div>
                        <div class="form-group">
                            <label class="checkbox-label" style="margin-top: 28px;">
                                <input type="checkbox" id="formFeatured">
                                Featured Product (Best Seller badge)
                            </label>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-section-title">Description</div>
                    <div class="form-group">
                        <label>Description (English)</label>
                        <textarea id="formDescription" placeholder="Describe your product..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Description (Arabic)</label>
                        <textarea id="formDescriptionAr" dir="rtl" placeholder="ŸàÿµŸÅ ÿßŸÑŸÖŸÜÿ™ÿ¨..."></textarea>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-section-title">Images <span style="font-weight:400;font-size:0.8rem;color:#888;">(Paste Google Drive links - auto-converts)</span></div>
                    <div class="form-group">
                        <label>Main Image URL</label>
                        <input type="text" id="formMainImage" placeholder="https://drive.google.com/..." onpaste="handleImagePaste(this)" oninput="convertGoogleDriveUrl(this)">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Image 2 URL</label>
                            <input type="text" id="formImage2" placeholder="https://..." onpaste="handleImagePaste(this)" oninput="convertGoogleDriveUrl(this)">
                        </div>
                        <div class="form-group">
                            <label>Image 3 URL</label>
                            <input type="text" id="formImage3" placeholder="https://..." onpaste="handleImagePaste(this)" oninput="convertGoogleDriveUrl(this)">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Image 4 URL</label>
                            <input type="text" id="formImage4" placeholder="https://..." onpaste="handleImagePaste(this)" oninput="convertGoogleDriveUrl(this)">
                        </div>
                        <div class="form-group">
                            <label>Image 5 URL</label>
                            <input type="text" id="formImage5" placeholder="https://..." onpaste="handleImagePaste(this)" oninput="convertGoogleDriveUrl(this)">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Image 6 URL</label>
                            <input type="text" id="formImage6" placeholder="https://..." onpaste="handleImagePaste(this)" oninput="convertGoogleDriveUrl(this)">
                        </div>
                        <div class="form-group">
                            <label>Image 7 URL</label>
                            <input type="text" id="formImage7" placeholder="https://..." onpaste="handleImagePaste(this)" oninput="convertGoogleDriveUrl(this)">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Image 8 URL</label>
                        <input type="text" id="formImage8" placeholder="https://..." onpaste="handleImagePaste(this)" oninput="convertGoogleDriveUrl(this)">
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-section-title">Additional Details</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Colors</label>
                            <input type="text" id="formColors" placeholder="Red, Blue, Green">
                        </div>
                        <div class="form-group">
                            <label>Colors (Arabic)</label>
                            <input type="text" id="formColorsAr" dir="rtl" placeholder="ÿ£ÿ≠ŸÖÿ±ÿå ÿ£ÿ≤ÿ±ŸÇÿå ÿ£ÿÆÿ∂ÿ±">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Packaging</label>
                            <input type="text" id="formPackaging" placeholder="Box of 10">
                        </div>
                        <div class="form-group">
                            <label>Packaging (Arabic)</label>
                            <input type="text" id="formPackagingAr" dir="rtl" placeholder="ÿπŸÑÿ®ÿ© ŸÖŸÜ Ÿ°Ÿ†">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Specifications (separate with |)</label>
                        <input type="text" id="formSpecifications" placeholder="Size: 10cm | Weight: 50g | Material: Plastic">
                    </div>
                    <div class="form-group">
                        <label>Specifications Arabic (separate with |)</label>
                        <input type="text" id="formSpecificationsAr" dir="rtl" placeholder="ÿßŸÑÿ≠ÿ¨ŸÖ: Ÿ°Ÿ† ÿ≥ŸÖ | ÿßŸÑŸàÿ≤ŸÜ: Ÿ•Ÿ† ÿ∫">
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-section-title">Extra Specifications <span style="font-weight:400;font-size:0.8rem;color:#888;">(only shown when filled)</span></div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Wattage</label>
                            <input type="text" id="formWattage" placeholder="e.g. 9W">
                        </div>
                        <div class="form-group">
                            <label>Voltage</label>
                            <input type="text" id="formVoltage" placeholder="e.g. 220-240V AC">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Plug Type</label>
                            <input type="text" id="formPlugType" placeholder="e.g. UK Type G (3-pin)">
                        </div>
                        <div class="form-group">
                            <label>Plug Type (Arabic)</label>
                            <input type="text" id="formPlugTypeAr" dir="rtl" placeholder="ÿ®ÿ±Ÿäÿ∑ÿßŸÜŸä ÿ´ŸÑÿßÿ´Ÿä">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Base Type</label>
                            <input type="text" id="formBaseType" placeholder="e.g. E27 (Standard screw)">
                        </div>
                        <div class="form-group">
                            <label>Base Type (Arabic)</label>
                            <input type="text" id="formBaseTypeAr" dir="rtl" placeholder="E27 (ŸÑŸàŸÑÿ®Ÿä ŸÇŸäÿßÿ≥Ÿä)">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Material</label>
                            <input type="text" id="formMaterial" placeholder="e.g. Polycarbonate + Aluminum">
                        </div>
                        <div class="form-group">
                            <label>Material (Arabic)</label>
                            <input type="text" id="formMaterialAr" dir="rtl" placeholder="ÿ®ŸàŸÑŸä ŸÉÿ±ÿ®ŸàŸÜÿßÿ™ + ÿ£ŸÑŸàŸÖŸÜŸäŸàŸÖ">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-section-title">Product Variants <span style="font-weight:400;font-size:0.8rem;color:#888;">(optional - for products with design options)</span></div>
                    <div id="variantsContainer"></div>
                    <button type="button" class="btn btn-small btn-primary" onclick="addVariantRow()" style="margin-top:8px;">+ Add Variant</button>
                </div>

                <div class="form-section">
                    <div class="form-section-title">Pricing Tiers <span style="font-weight:400;font-size:0.8rem;color:#888;">(optional - quantity discounts)</span></div>
                    <div id="tiersContainer"></div>
                    <button type="button" class="btn btn-small btn-primary" onclick="addTierRow()" style="margin-top:8px;">+ Add Pricing Tier</button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal()">Cancel</button>
                <button class="btn btn-success" onclick="saveProduct()">Save Product</button>
            </div>
        </div>
    </div>

    <!-- Quick Stock Modal -->
    <div class="modal-overlay" id="stockModal">
        <div class="modal" style="max-width:420px;">
            <div class="modal-header">
                <h2>Update Stock</h2>
                <button class="modal-close" onclick="closeStockModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom:20px; font-size:1.1rem;">
                    <strong id="stockProductName"></strong>
                </p>
                <p style="margin-bottom:20px; color:var(--text-light);">
                    Current Stock: <strong style="color:var(--primary); font-size:1.2rem;" id="stockCurrentQty"></strong>
                </p>
                <div class="form-group">
                    <label>New Quantity</label>
                    <input type="number" id="stockNewQty" min="0" style="font-size:1.2rem; text-align:center;">
                </div>
                <input type="hidden" id="stockSlug">
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeStockModal()">Cancel</button>
                <button class="btn btn-success" onclick="updateStock()">Update Stock</button>
            </div>
        </div>
    </div>

    <script>
        let products = [];
        let authKey = '';

        function checkAuth() {
            const params = new URLSearchParams(window.location.search);
            const urlKey = params.get('key');
            if (urlKey) {
                verifyKey(urlKey);
            }
        }

        async function verifyKey(key) {
            try {
                const response = await fetch('/api/admin/verify?key=' + encodeURIComponent(key) + '&t=' + Date.now());
                if (response.ok) {
                    authKey = key;
                    showAdmin();
                } else {
                    document.getElementById('authError').style.display = 'block';
                    document.getElementById('authKey').style.borderColor = '#dc3545';
                }
            } catch (e) {
                document.getElementById('authError').style.display = 'block';
                document.getElementById('authKey').style.borderColor = '#dc3545';
            }
        }

        function authenticate() {
            const input = document.getElementById('authKey').value;
            if (!input) return;
            verifyKey(input);
        }

        function showAdmin() {
            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
            loadProducts();
        }

        async function loadProducts() {
            try {
                const response = await fetch('/api/products?t=' + Date.now());
                products = await response.json();
                renderProducts();
                updateStats();
            } catch (error) {
                document.getElementById('productsBody').innerHTML = 
                    '<tr><td colspan="7" class="loading">Error loading products. Please refresh.</td></tr>';
            }
        }

        function renderProducts(filtered = null) {
            const list = filtered || products;
            const tbody = document.getElementById('productsBody');
            
            if (list.length === 0) {
                tbody.innerHTML = `
                    <tr><td colspan="7">
                        <div class="empty-state">
                            <div class="empty-state-icon">üì≠</div>
                            <h3>No products found</h3>
                            <p>Add your first product to get started!</p>
                            <button class="btn btn-primary" onclick="openAddModal()">+ Add Product</button>
                        </div>
                    </td></tr>
                `;
                return;
            }

            const isFiltered = filtered !== null;

            tbody.innerHTML = list.map((p, idx) => {
                const img = p.image && p.image.startsWith('http')
                    ? `<img src="${p.image}" class="product-img" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2250%22 height=%2250%22><rect fill=%22%23f5f5f5%22 width=%22100%25%22 height=%22100%25%22/><text x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 font-size=%2220%22>üì¶</text></svg>'">`
                    : `<div class="product-img" style="display:flex;align-items:center;justify-content:center;font-size:28px;">${p.image || 'üì¶'}</div>`;

                const stock = p.totalStock !== undefined ? p.totalStock : p.quantity;
                let qtyClass = 'qty-ok';
                if (stock === 0) qtyClass = 'qty-out';
                else if (stock < 10) qtyClass = 'qty-low';

                const isFirst = idx === 0;
                const isLast = idx === list.length - 1;

                return `
                    <tr>
                        <td>
                            ${isFiltered ? '' : `<div class="reorder-arrows">
                                <button class="reorder-btn" onclick="moveProduct(${p.id}, 'up')" ${isFirst ? 'disabled' : ''} title="Move up">&#9650;</button>
                                <button class="reorder-btn" onclick="moveProduct(${p.id}, 'down')" ${isLast ? 'disabled' : ''} title="Move down">&#9660;</button>
                            </div>`}
                        </td>
                        <td>${img}</td>
                        <td>
                            <div class="product-name">${p.name}</div>
                            ${p.nameAr ? `<div class="product-name-ar">${p.nameAr}</div>` : ''}
                            <div class="product-slug">${p.slug}</div>
                        </td>
                        <td>${p.category ? `<span class="category-tag">${p.category}</span>` : '-'}</td>
                        <td><span class="price-tag">AED ${p.price}</span></td>
                        <td>
                            <span class="qty-badge ${qtyClass}" onclick="openStockModal('${p.slug}', '${p.name.replace(/'/g, "\\'")}', ${stock})">
                                ${stock}
                            </span>
                        </td>
                        <td class="actions">
                            <button class="btn btn-small btn-primary" onclick="openEditModal(${p.id})">Edit</button>
                            <button class="btn btn-small btn-danger" onclick="deleteProduct(${p.id}, '${p.slug}')">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function updateStats() {
            document.getElementById('statTotal').textContent = products.length;
            const getStock = p => p.totalStock !== undefined ? p.totalStock : p.quantity;
            document.getElementById('statInStock').textContent = products.filter(p => getStock(p) > 0).length;
            document.getElementById('statLowStock').textContent = products.filter(p => getStock(p) > 0 && getStock(p) < 10).length;
            document.getElementById('statOutOfStock').textContent = products.filter(p => getStock(p) === 0).length;
        }

        let activeStockFilter = null;

        function filterByStock(type) {
            const getStock = p => p.totalStock !== undefined ? p.totalStock : p.quantity;

            // Toggle off if same filter clicked again
            if (activeStockFilter === type) {
                clearStockFilter();
                return;
            }

            activeStockFilter = type;
            let filtered;
            let label;

            if (type === 'all') {
                filtered = products;
                label = `Showing all ${filtered.length} products`;
            } else if (type === 'instock') {
                filtered = products.filter(p => getStock(p) > 0);
                label = `${filtered.length} products in stock`;
            } else if (type === 'low') {
                filtered = products.filter(p => getStock(p) > 0 && getStock(p) < 10);
                label = `${filtered.length} products with low stock (< 10)`;
            } else if (type === 'out') {
                filtered = products.filter(p => getStock(p) === 0);
                label = `${filtered.length} products out of stock`;
            }

            // Highlight selected card
            document.querySelectorAll('#stats .stat-card').forEach(c => c.classList.remove('selected'));
            event.currentTarget.classList.add('selected');

            // Show filter banner
            const banner = document.getElementById('stockFilterBanner');
            document.getElementById('stockFilterLabel').textContent = label;
            banner.classList.add('active');

            // Clear search box and render filtered
            document.getElementById('searchBox').value = '';
            renderProducts(filtered);

            // Scroll to table
            document.querySelector('.products-table').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function clearStockFilter() {
            activeStockFilter = null;
            document.querySelectorAll('#stats .stat-card').forEach(c => c.classList.remove('selected'));
            document.getElementById('stockFilterBanner').classList.remove('active');
            document.getElementById('searchBox').value = '';
            renderProducts();
        }

        function filterProducts() {
            // Clear stock filter when searching
            if (activeStockFilter) {
                activeStockFilter = null;
                document.querySelectorAll('#stats .stat-card').forEach(c => c.classList.remove('selected'));
                document.getElementById('stockFilterBanner').classList.remove('active');
            }
            const term = document.getElementById('searchBox').value.toLowerCase();
            if (!term) { renderProducts(); return; }
            const filtered = products.filter(p =>
                p.name.toLowerCase().includes(term) ||
                (p.nameAr && p.nameAr.includes(term)) ||
                (p.category && p.category.toLowerCase().includes(term)) ||
                (p.slug && p.slug.toLowerCase().includes(term))
            );
            renderProducts(filtered);
        }

        function refreshProducts() {
            document.getElementById('productsBody').innerHTML =
                '<tr><td colspan="7" class="loading"><div class="loading-spinner"></div><div>Loading...</div></td></tr>';
            loadProducts();
        }

        async function moveProduct(id, direction) {
            // Find current index in the products array
            const idx = products.findIndex(p => p.id === id);
            if (idx === -1) return;

            const swapIdx = direction === 'up' ? idx - 1 : idx + 1;
            if (swapIdx < 0 || swapIdx >= products.length) return;

            const neighborId = products[swapIdx].id;

            // Disable all reorder buttons during request
            document.querySelectorAll('.reorder-btn').forEach(b => b.disabled = true);

            try {
                const res = await fetch(`/api/admin/reorder?key=${authKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id1: id, id2: neighborId })
                });
                const data = await res.json();
                if (data.success) {
                    // Swap locally for instant feedback
                    const temp = products[idx];
                    products[idx] = products[swapIdx];
                    products[swapIdx] = temp;
                    renderProducts();
                    // Sync from server to confirm persistence
                    loadProducts();
                } else {
                    alert('Reorder failed: ' + (data.error || 'Unknown error'));
                    renderProducts();
                }
            } catch (e) {
                alert('Reorder failed: ' + e.message);
                renderProducts();
            }
        }

        document.getElementById('formName').addEventListener('input', function() {
            const slug = document.getElementById('formSlug');
            if (!slug.value || slug.dataset.autoGenerated === 'true') {
                slug.value = this.value.toLowerCase().replace(/[^a-z0-9\s-]/g, '').replace(/\s+/g, '-').replace(/-+/g, '-');
                slug.dataset.autoGenerated = 'true';
            }
        });
        
        document.getElementById('formSlug').addEventListener('input', function() {
            this.dataset.autoGenerated = 'false';
        });

        const DELIVERY_FEE = 18;
        function calcMinPrice() {
            const cost = parseFloat(document.getElementById('formCost').value);
            const minPriceEl = document.getElementById('formMinPrice');
            if (!cost || cost <= 0) {
                minPriceEl.value = '';
                return 0;
            }
            const minPrice = Math.ceil(((cost * 2) + (DELIVERY_FEE / 2)) / 0.97 * 100) / 100;
            minPriceEl.value = minPrice.toFixed(2) + ' AED';
            return minPrice;
        }

        function openAddModal() {
            document.getElementById('modalTitle').innerHTML = 'Add Product';
            document.getElementById('editId').value = '';
            clearForm();
            document.getElementById('variantsContainer').innerHTML = '';
            document.getElementById('tiersContainer').innerHTML = '';
            document.getElementById('productModal').classList.add('active');
            document.getElementById('formName').focus();
        }

        function openEditModal(id) {
            const product = products.find(p => p.id === id);
            if (!product) return;
            
            document.getElementById('modalTitle').innerHTML = 'Edit Product';
            document.getElementById('editId').value = id;
            
            document.getElementById('formName').value = product.name || '';
            document.getElementById('formNameAr').value = product.nameAr || '';
            document.getElementById('formSlug').value = product.slug || '';
            document.getElementById('formSlug').dataset.autoGenerated = 'false';
            document.getElementById('formCategory').value = product.category || '';
            document.getElementById('formCategoryAr').value = product.categoryAr || '';
            document.getElementById('formPrice').value = product.price || '';
            document.getElementById('formCost').value = product.cost || '';
            calcMinPrice();
            document.getElementById('formQuantity').value = product.quantity || 0;
            document.getElementById('formDescription').value = product.description || '';
            document.getElementById('formDescriptionAr').value = product.descriptionAr || '';
            document.getElementById('formMainImage').value = product.image || '';
            document.getElementById('formImage2').value = product.images && product.images[1] || '';
            document.getElementById('formImage3').value = product.images && product.images[2] || '';
            document.getElementById('formImage4').value = product.images && product.images[3] || '';
            document.getElementById('formImage5').value = product.images && product.images[4] || '';
            document.getElementById('formImage6').value = product.images && product.images[5] || '';
            document.getElementById('formImage7').value = product.images && product.images[6] || '';
            document.getElementById('formImage8').value = product.images && product.images[7] || '';
            document.getElementById('formColors').value = product.colors || '';
            document.getElementById('formColorsAr').value = product.colorsAr || '';
            document.getElementById('formPackaging').value = product.packaging || '';
            document.getElementById('formPackagingAr').value = product.packagingAr || '';
            document.getElementById('formSpecifications').value = product.specifications ? product.specifications.join(' | ') : '';
            document.getElementById('formSpecificationsAr').value = product.specificationsAr ? product.specificationsAr.join(' | ') : '';
            document.getElementById('formFeatured').checked = product.featured;
            // Extra specs
            document.getElementById('formWattage').value = product.wattage || '';
            document.getElementById('formVoltage').value = product.voltage || '';
            document.getElementById('formPlugType').value = product.plugType || '';
            document.getElementById('formPlugTypeAr').value = product.plugTypeAr || '';
            document.getElementById('formBaseType').value = product.baseType || '';
            document.getElementById('formBaseTypeAr').value = product.baseTypeAr || '';
            document.getElementById('formMaterial').value = product.material || '';
            document.getElementById('formMaterialAr').value = product.materialAr || '';

            // Variants
            document.getElementById('variantsContainer').innerHTML = '';
            if (product.variants && product.variants.length > 0) {
                product.variants.forEach(v => addVariantRow(v));
            }

            // Pricing tiers
            document.getElementById('tiersContainer').innerHTML = '';
            if (product.pricingTiers && product.pricingTiers.length > 0) {
                product.pricingTiers.forEach(t => addTierRow(t));
            }

            document.getElementById('productModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('productModal').classList.remove('active');
        }

        function clearForm() {
            const inputs = document.querySelectorAll('#productModal input, #productModal textarea');
            inputs.forEach(input => {
                if (input.type === 'checkbox') input.checked = false;
                else input.value = '';
            });
            document.getElementById('formSlug').dataset.autoGenerated = 'true';
            document.getElementById('variantsContainer').innerHTML = '';
            document.getElementById('tiersContainer').innerHTML = '';
        }

        async function saveProduct() {
            const id = document.getElementById('editId').value;
            const data = {
                slug: document.getElementById('formSlug').value.trim(),
                name: document.getElementById('formName').value.trim(),
                nameAr: document.getElementById('formNameAr').value.trim(),
                category: document.getElementById('formCategory').value.trim(),
                categoryAr: document.getElementById('formCategoryAr').value.trim(),
                price: parseFloat(document.getElementById('formPrice').value) || calcMinPrice() || 0,
                cost: parseFloat(document.getElementById('formCost').value) || 0,
                quantity: parseInt(document.getElementById('formQuantity').value) || 0,
                description: document.getElementById('formDescription').value.trim(),
                descriptionAr: document.getElementById('formDescriptionAr').value.trim(),
                mainImage: document.getElementById('formMainImage').value.trim(),
                image2: document.getElementById('formImage2').value.trim(),
                image3: document.getElementById('formImage3').value.trim(),
                image4: document.getElementById('formImage4').value.trim(),
                image5: document.getElementById('formImage5').value.trim(),
                image6: document.getElementById('formImage6').value.trim(),
                image7: document.getElementById('formImage7').value.trim(),
                image8: document.getElementById('formImage8').value.trim(),
                colors: document.getElementById('formColors').value.trim(),
                colorsAr: document.getElementById('formColorsAr').value.trim(),
                packaging: document.getElementById('formPackaging').value.trim(),
                packagingAr: document.getElementById('formPackagingAr').value.trim(),
                specifications: document.getElementById('formSpecifications').value.trim(),
                specificationsAr: document.getElementById('formSpecificationsAr').value.trim(),
                featured: document.getElementById('formFeatured').checked ? 1 : 0,
                wattage: document.getElementById('formWattage').value.trim(),
                voltage: document.getElementById('formVoltage').value.trim(),
                plugType: document.getElementById('formPlugType').value.trim(),
                plugTypeAr: document.getElementById('formPlugTypeAr').value.trim(),
                baseType: document.getElementById('formBaseType').value.trim(),
                baseTypeAr: document.getElementById('formBaseTypeAr').value.trim(),
                material: document.getElementById('formMaterial').value.trim(),
                materialAr: document.getElementById('formMaterialAr').value.trim(),
                variants: getVariantsFromForm(),
                pricingTiers: getTiersFromForm()
            };

            if (!data.slug || !data.name || !data.price) {
                alert('Please fill in required fields: Name, Slug, Price');
                return;
            }

            try {
                const url = id 
                    ? `/api/admin/product?key=${authKey}&action=update&id=${id}`
                    : `/api/admin/product?key=${authKey}&action=add`;
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    closeModal();
                    loadProducts();
                } else {
                    alert('Error: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Error saving product: ' + error.message);
            }
        }

        async function deleteProduct(id, slug) {
            if (!confirm(`Delete "${slug}"? This cannot be undone.`)) return;
            
            try {
                const response = await fetch(`/api/admin/product?key=${authKey}&action=delete&id=${id}`);
                const result = await response.json();
                if (result.success) loadProducts();
                else alert('Error: ' + (result.error || 'Unknown error'));
            } catch (error) {
                alert('Error deleting product: ' + error.message);
            }
        }

        function openStockModal(slug, name, qty) {
            document.getElementById('stockSlug').value = slug;
            document.getElementById('stockProductName').textContent = name;
            document.getElementById('stockCurrentQty').textContent = qty;
            document.getElementById('stockNewQty').value = qty;
            document.getElementById('stockModal').classList.add('active');
            document.getElementById('stockNewQty').focus();
            document.getElementById('stockNewQty').select();
        }

        function closeStockModal() {
            document.getElementById('stockModal').classList.remove('active');
        }

        async function updateStock() {
            const slug = document.getElementById('stockSlug').value;
            const newQty = document.getElementById('stockNewQty').value;
            
            try {
                const response = await fetch(`/api/admin/restock?key=${authKey}&slug=${slug}&set=${newQty}`);
                const result = await response.json();
                if (result.success) { 
                    closeStockModal(); 
                    loadProducts();
                    localStorage.removeItem('orlo_products_cache');
                    localStorage.removeItem('orlo_products_cache_time');
                }
                else alert('Error: ' + (result.error || 'Unknown error'));
            } catch (error) {
                alert('Error updating stock: ' + error.message);
            }
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') { closeModal(); closeStockModal(); }
        });

        function addVariantRow(data) {
            const container = document.getElementById('variantsContainer');
            const row = document.createElement('div');
            row.className = 'variant-row';
            row.style.cssText = 'display:grid; grid-template-columns:1fr 1fr 1fr 80px 80px 40px; gap:8px; margin-bottom:8px; align-items:center;';
            row.innerHTML = `
                <input type="text" class="v-name" value="${data ? (data.name || '') : ''}" placeholder="Name EN">
                <input type="text" class="v-nameAr" value="${data ? (data.nameAr || '') : ''}" dir="rtl" placeholder="Name AR">
                <input type="text" class="v-image" value="${data ? (data.image || '') : ''}" placeholder="Image URL" onpaste="handleImagePaste(this)" oninput="convertGoogleDriveUrl(this)">
                <input type="number" class="v-price" value="${data ? (data.price || 0) : 0}" step="0.01" min="0" style="text-align:center;" placeholder="Price AED">
                <input type="number" class="v-qty" value="${data ? (data.quantity || 0) : 0}" min="0" style="text-align:center;" placeholder="Stock">
                <button type="button" class="btn btn-small btn-danger" onclick="this.parentElement.remove()" style="padding:4px 8px;">&#10005;</button>
            `;
            container.appendChild(row);
        }

        function addTierRow(data) {
            const container = document.getElementById('tiersContainer');
            const row = document.createElement('div');
            row.className = 'tier-row';
            row.style.cssText = 'display:grid; grid-template-columns:120px 120px 40px; gap:8px; margin-bottom:8px; align-items:center;';
            row.innerHTML = `
                <input type="number" class="t-minQty" value="${data ? (data.minQty || '') : ''}" min="1" placeholder="Min Qty">
                <input type="number" class="t-discount" value="${data ? (data.discountPercent || '') : ''}" step="0.1" min="0" max="100" placeholder="Discount %">
                <button type="button" class="btn btn-small btn-danger" onclick="this.parentElement.remove()" style="padding:4px 8px;">&#10005;</button>
            `;
            container.appendChild(row);
        }

        function getVariantsFromForm() {
            const rows = document.querySelectorAll('#variantsContainer .variant-row');
            const variants = [];
            rows.forEach(row => {
                const name = row.querySelector('.v-name').value.trim();
                if (!name) return;
                variants.push({
                    name: name,
                    nameAr: row.querySelector('.v-nameAr').value.trim(),
                    image: row.querySelector('.v-image').value.trim(),
                    price: parseFloat(row.querySelector('.v-price').value) || 0,
                    quantity: parseInt(row.querySelector('.v-qty').value) || 0
                });
            });
            return variants;
        }

        function getTiersFromForm() {
            const rows = document.querySelectorAll('#tiersContainer .tier-row');
            const tiers = [];
            rows.forEach(row => {
                const minQty = parseInt(row.querySelector('.t-minQty').value);
                const discount = parseFloat(row.querySelector('.t-discount').value);
                if (!minQty || isNaN(discount)) return;
                tiers.push({ minQty: minQty, discountPercent: discount });
            });
            return tiers;
        }

        document.getElementById('authKey').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') authenticate();
        });
        
        // Google Drive URL conversion functions
        function convertGoogleDriveUrl(input) {
            const url = input.value.trim();
            if (url.includes('drive.google.com/file/d/')) {
                const converted = extractAndConvertGoogleDriveUrl(url);
                if (converted) {
                    input.value = converted;
                }
            }
        }
        
        function handleImagePaste(input) {
            setTimeout(() => {
                convertGoogleDriveUrl(input);
            }, 10);
        }
        
        function extractAndConvertGoogleDriveUrl(url) {
            // Extract file ID from Google Drive URL
            // Input: https://drive.google.com/file/d/19ylQVPzfZrZ41zMPuWk_OPHFsKW5lC4W/view?usp=...
            // Output: https://lh3.googleusercontent.com/d/19ylQVPzfZrZ41zMPuWk_OPHFsKW5lC4W
            
            let fileId = null;
            
            // Extract from /file/d/ format
            const match = url.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
            if (match) {
                fileId = match[1];
            }
            
            if (fileId) {
                return `https://lh3.googleusercontent.com/d/${fileId}`;
            }
            
            return null;
        }
        
        // ========== ORDERS FUNCTIONS ==========
        let orders = [];
        let filteredOrders = [];
        let shippedOrders = JSON.parse(localStorage.getItem('orlo_shipped_orders') || '[]');
        
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            if (tab === 'products') {
                document.querySelector('.tab:first-child').classList.add('active');
                document.getElementById('productsTab').classList.add('active');
            } else {
                document.querySelector('.tab:last-child').classList.add('active');
                document.getElementById('ordersTab').classList.add('active');
                loadOrders();
            }
        }
        
        function switchView(view) {
            document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.dashboard-view').forEach(v => v.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(view + 'View').classList.add('active');
        }
        
        function populateProductFilter() {
            const select = document.getElementById('productFilter');
            select.innerHTML = '<option value="all">All Products</option>';
            
            // Get unique product names from orders (excluding delivery)
            const productNames = new Set();
            orders.forEach(order => {
                order.items.forEach(item => {
                    if (!item.name.toLowerCase().includes('delivery')) {
                        productNames.add(item.name);
                    }
                });
            });
            
            // Sort alphabetically and add to dropdown
            Array.from(productNames).sort().forEach(name => {
                select.innerHTML += `<option value="${name}">${name}</option>`;
            });
        }
        
        function applyFilters() {
            const dateFilter = document.getElementById('dateFilter').value;
            const productFilter = document.getElementById('productFilter').value;
            const shippingFilter = document.getElementById('shippingFilter').value;
            
            const now = new Date();
            let startDate = new Date(0); // Beginning of time
            
            if (dateFilter === 'today') {
                startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            } else if (dateFilter === 'week') {
                startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            } else if (dateFilter === 'month') {
                startDate = new Date(now.getFullYear(), now.getMonth(), 1);
            } else if (dateFilter === 'year') {
                startDate = new Date(now.getFullYear(), 0, 1);
            }
            
            filteredOrders = orders.filter(order => {
                const orderDate = new Date(order.created * 1000);
                if (orderDate < startDate) return false;
                
                // Shipping filter
                if (shippingFilter === 'paid' && order.shipping_amount === 0) return false;
                if (shippingFilter === 'free' && order.shipping_amount > 0) return false;
                
                // Product filter - exact match on item name
                if (productFilter !== 'all') {
                    const hasProduct = order.items.some(item => item.name === productFilter);
                    if (!hasProduct) return false;
                }
                
                return true;
            });
            
            renderOrders();
            renderProductsSales();
            renderShippingSummary();
            updateOrderStats();
        }
        
        async function loadOrders() {
            document.getElementById('ordersContainer').innerHTML = `
                <div class="orders-loading">
                    <div class="loading-spinner"></div>
                    <div>Loading orders from Stripe...</div>
                </div>
            `;
            
            try {
                const response = await fetch(`/api/admin/orders?key=${authKey}&t=${Date.now()}`);
                const data = await response.json();
                
                if (data.error) {
                    document.getElementById('ordersContainer').innerHTML = `
                        <div class="orders-empty">
                            <div class="orders-empty-icon">‚ö†Ô∏è</div>
                            <h3>Error loading orders</h3>
                            <p>${data.error}</p>
                        </div>
                    `;
                    return;
                }
                
                orders = data.orders || [];
                
                // Apply local shipped status
                orders = orders.map(order => ({
                    ...order,
                    status: shippedOrders.includes(order.id) ? 'shipped' : order.status
                }));
                
                // Populate product filter
                populateProductFilter();
                
                // Apply filters
                applyFilters();
                
            } catch (error) {
                document.getElementById('ordersContainer').innerHTML = `
                    <div class="orders-empty">
                        <div class="orders-empty-icon">‚ùå</div>
                        <h3>Failed to load orders</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }
        
        function getProductCost(itemName) {
            // Match product by name and get cost
            const product = products.find(p => 
                itemName.toLowerCase().includes(p.name.toLowerCase()) ||
                p.name.toLowerCase().includes(itemName.toLowerCase())
            );
            return product ? (product.cost || 0) : 0;
        }
        
        function renderOrders() {
            const container = document.getElementById('ordersContainer');
            document.getElementById('ordersCount').textContent = filteredOrders.length + ' orders';
            
            if (filteredOrders.length === 0) {
                container.innerHTML = `
                    <div class="orders-empty">
                        <div class="orders-empty-icon">üì≠</div>
                        <h3>No orders found</h3>
                        <p>Try adjusting your filters</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = filteredOrders.map(order => {
                const date = new Date(order.created * 1000);
                const dateStr = date.toLocaleDateString('en-GB', { 
                    day: 'numeric', month: 'short', year: 'numeric',
                    hour: '2-digit', minute: '2-digit'
                });
                
                const address = order.shipping_address;
                const addressStr = address ? 
                    `${address.line1 || ''}${address.line2 ? ', ' + address.line2 : ''}<br>${address.city || ''} ${address.postal_code || ''}<br>${address.country || ''}` 
                    : 'No address';
                
                const addressCopy = address ?
                    `${order.customer_name}\n${address.line1 || ''}${address.line2 ? ', ' + address.line2 : ''}\n${address.city || ''} ${address.postal_code || ''}\n${order.customer_phone || ''}`
                    : '';
                
                // Calculate order cost and profit
                let orderCost = 0;
                order.items.forEach(item => {
                    if (!item.name.toLowerCase().includes('delivery')) {
                        orderCost += getProductCost(item.name) * item.quantity;
                    }
                });
                const productRevenue = (order.amount_total - (order.shipping_amount || 0)) / 100;
                const orderProfit = productRevenue - orderCost;
                
                return `
                    <div class="order-card">
                        <div class="order-header">
                            <div>
                                <span class="order-id">#${order.id.slice(-8).toUpperCase()}</span>
                                <span class="order-date">${dateStr}</span>
                            </div>
                            <div style="display:flex; align-items:center; gap:10px;">
                                <span class="order-status ${order.status}">${order.status}</span>
                                <span class="order-amount">AED ${(order.amount_total / 100).toFixed(2)}</span>
                            </div>
                        </div>
                        <div class="order-body">
                            <div class="order-customer">
                                <div class="order-customer-info">
                                    <h4>üë§ Customer</h4>
                                    <p><strong>${order.customer_name}</strong><br>
                                    ${order.customer_email}<br>
                                    ${order.customer_phone}</p>
                                </div>
                                <div class="order-customer-info">
                                    <h4>üìç Shipping Address</h4>
                                    <p>${addressStr}</p>
                                </div>
                            </div>
                            <div class="order-items">
                                <h4>üì¶ Items</h4>
                                ${order.items.map(item => {
                                    const isDelivery = item.name.toLowerCase().includes('delivery');
                                    const itemCost = isDelivery ? 0 : getProductCost(item.name) * item.quantity;
                                    const itemProfit = isDelivery ? 0 : (item.amount / 100) - itemCost;
                                    return `
                                    <div class="order-item">
                                        <span class="order-item-name">${item.name}</span>
                                        <span class="order-item-qty">√ó ${item.quantity}</span>
                                        <span class="order-item-price">AED ${(item.amount / 100).toFixed(2)}</span>
                                        ${!isDelivery ? `<span style="color:${itemProfit >= 0 ? 'var(--success)' : 'var(--danger)'};font-size:0.8rem;">P: ${itemProfit.toFixed(2)}</span>` : ''}
                                    </div>
                                `}).join('')}
                                <div class="order-item" style="border-top:2px solid #ddd;margin-top:10px;padding-top:10px;font-weight:600;">
                                    <span>Profit</span>
                                    <span></span>
                                    <span style="color:${orderProfit >= 0 ? 'var(--success)' : 'var(--danger)'}">AED ${orderProfit.toFixed(2)}</span>
                                    <span></span>
                                </div>
                            </div>
                            <div class="order-actions">
                                <button class="btn btn-small btn-outline" onclick="copyAddress(\`${addressCopy.replace(/`/g, "'")}\`)">
                                    üìã Copy Address
                                </button>
                                ${order.status === 'pending' ? `
                                    <button class="btn btn-small btn-success" onclick="markShipped('${order.id}', '${order.customer_email}')">
                                        ‚úâÔ∏è Mark Shipped
                                    </button>
                                ` : `
                                    <button class="btn btn-small" disabled style="background:#d4edda;color:#155724;">
                                        ‚úì Shipped
                                    </button>
                                `}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function renderProductsSales() {
            const tbody = document.getElementById('productsSalesBody');
            
            // Aggregate sales by product
            const productSales = {};
            
            filteredOrders.forEach(order => {
                order.items.forEach(item => {
                    if (item.name.toLowerCase().includes('delivery')) return;
                    
                    const key = item.name;
                    if (!productSales[key]) {
                        productSales[key] = {
                            name: item.name,
                            units: 0,
                            revenue: 0,
                            cost: 0
                        };
                    }
                    productSales[key].units += item.quantity;
                    productSales[key].revenue += item.amount / 100;
                    productSales[key].cost += getProductCost(item.name) * item.quantity;
                });
            });
            
            const salesArray = Object.values(productSales).sort((a, b) => b.revenue - a.revenue);
            
            if (salesArray.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:40px;color:#999;">No sales data</td></tr>';
                return;
            }
            
            tbody.innerHTML = salesArray.map(p => {
                const profit = p.revenue - p.cost;
                const margin = p.revenue > 0 ? ((profit / p.revenue) * 100).toFixed(1) : 0;
                return `
                    <tr>
                        <td><strong>${p.name}</strong></td>
                        <td>${p.units}</td>
                        <td class="price-tag">AED ${p.revenue.toFixed(2)}</td>
                        <td>AED ${p.cost.toFixed(2)}</td>
                        <td style="color:${profit >= 0 ? 'var(--success)' : 'var(--danger)'};font-weight:600;">AED ${profit.toFixed(2)}</td>
                        <td>${margin}%</td>
                    </tr>
                `;
            }).join('');
        }
        
        function renderShippingSummary() {
            const paidShipping = filteredOrders.filter(o => o.shipping_amount > 0);
            const freeShipping = filteredOrders.filter(o => o.shipping_amount === 0);
            const totalCollected = paidShipping.reduce((sum, o) => sum + (o.shipping_amount || 0), 0) / 100;
            
            document.getElementById('paidShippingCount').textContent = paidShipping.length;
            document.getElementById('paidShippingAmount').textContent = 'AED ' + totalCollected.toFixed(2);
            document.getElementById('freeShippingCount').textContent = freeShipping.length;
            document.getElementById('totalShippingCollected').textContent = 'AED ' + totalCollected.toFixed(2);
            
            // Shipping table
            const tbody = document.getElementById('shippingTableBody');
            tbody.innerHTML = filteredOrders.map(order => {
                const date = new Date(order.created * 1000);
                const dateStr = date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
                const shippingType = order.shipping_amount > 0 ? 'Paid' : 'Free';
                const shippingClass = order.shipping_amount > 0 ? 'qty-low' : 'qty-ok';
                
                return `
                    <tr>
                        <td>${dateStr}</td>
                        <td>${order.customer_name}</td>
                        <td class="price-tag">AED ${(order.amount_total / 100).toFixed(2)}</td>
                        <td>AED ${((order.shipping_amount || 0) / 100).toFixed(2)}</td>
                        <td><span class="qty-badge ${shippingClass}">${shippingType}</span></td>
                    </tr>
                `;
            }).join('');
        }
        
        function updateOrderStats() {
            const totalRevenue = filteredOrders.reduce((sum, o) => sum + o.amount_total, 0) / 100;
            const shippingCollected = filteredOrders.reduce((sum, o) => sum + (o.shipping_amount || 0), 0) / 100;
            const productRevenue = totalRevenue - shippingCollected;
            
            let totalCost = 0;
            filteredOrders.forEach(order => {
                order.items.forEach(item => {
                    if (!item.name.toLowerCase().includes('delivery')) {
                        totalCost += getProductCost(item.name) * item.quantity;
                    }
                });
            });
            
            const profit = productRevenue - totalCost;
            const pending = filteredOrders.filter(o => o.status === 'pending').length;
            
            document.getElementById('statRevenue').textContent = 'AED ' + productRevenue.toFixed(0);
            document.getElementById('statCost').textContent = 'AED ' + totalCost.toFixed(0);
            document.getElementById('statProfit').textContent = 'AED ' + profit.toFixed(0);
            document.getElementById('statShipping').textContent = 'AED ' + shippingCollected.toFixed(0);
            document.getElementById('statTotalOrders').textContent = filteredOrders.length;
            document.getElementById('statPendingOrders').textContent = pending;
            document.getElementById('pendingOrdersBadge').textContent = pending;
        }
        
        function copyAddress(address) {
            navigator.clipboard.writeText(address).then(() => {
                alert('Address copied to clipboard!');
            }).catch(() => {
                prompt('Copy this address:', address);
            });
        }
        
        async function markShipped(orderId, customerEmail) {
    if (!customerEmail || customerEmail === 'N/A') {
        alert('Cannot ship: no customer email on this order.');
        return;
    }
    if (!confirm('Mark this order as shipped? An email will be sent to ' + customerEmail)) return;

    const order = orders.find(o => o.id === orderId);

    try {
        const response = await fetch(`/api/admin/ship-order?key=${authKey}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                order_id: orderId,
                customer_email: customerEmail,
                customer_name: order?.customer_name || '',
                items: order?.items || []
            })
        });

        const data = await response.json();

        if (data.success) {
            // Persist shipped status to localStorage
            if (!shippedOrders.includes(orderId)) {
                shippedOrders.push(orderId);
                localStorage.setItem('orlo_shipped_orders', JSON.stringify(shippedOrders));
            }

            orders = orders.map(o => o.id === orderId ? {...o, status: 'shipped'} : o);
            applyFilters();

            if (data.email_sent) {
                alert('Shipped! Email sent to ' + customerEmail);
            } else {
                alert('Marked as shipped, but email failed: ' + (data.email_error || 'Unknown error'));
            }
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}
        
        checkAuth();
    </script>
</body>
</html>
